---

- name: deploy stack with registry credentials
  command: >
    retry=5
    i=1;
    while [[ $i -lt $retry ]]; do
      docker stack deploy --with-registry-auth --compose-file  docker-compose.yml "{{ stack_name }}";
      ret=$?;
      if [[ $ret -eq 0 ]]; then echo 'Stack created'; break;
      else
        echo "Stack creation failed, retrying in 3 seconds.." >&2;
        sleep 3;
        i=$(( i + 1 ));
      fi;
      if [[ $i -ge $retry ]]; then
        echo "Stack creation failed!"; exit 1;
      fi;
    done;
  args:
    chdir: "{{ stack_directory }}"
  when: deploy_with_auth | default(true)

- name: deploy stack without registry credentials
  command: >
    retry=5
    i=1;
    while [[ $i -lt $retry ]]; do
      docker stack deploy --compose-file docker-compose.yml "{{ stack_name }}";
      ret=$?;
      if [[ $ret -eq 0 ]]; then echo 'Stack created'; break;
      else
        echo "Stack creation failed, retrying in 3 seconds.." >&2;
        sleep 3;
        i=$(( i + 1 ));
      fi;
      if [[ $i -ge $retry ]]; then
        echo "Stack creation failed!"; exit 1;
      fi;
    done;
  args:
    chdir: "{{ stack_directory }}"
  when: not docker_registry_password_auth | default(true)
